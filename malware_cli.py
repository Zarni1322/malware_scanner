import yara
import hashlib
from tabulate import tabulate

def calculate_file_hash(file_path, hash_algorithm="sha256"):
    hasher = hashlib.new(hash_algorithm)
    with open(file_path, "rb") as f:
        while chunk := f.read(8192):
            hasher.update(chunk)
    return hasher.hexdigest()

def save_hash_to_file(file_path, hash_value):
    filename = file_path.split("/")[-1]  # Extract the file name
    with open(filename + "_hash.txt", "w") as f:
        f.write(hash_value)

def scan_file(file_path, yara_rules_path):
    rules = yara.compile(filepath=yara_rules_path)
    matches = rules.match(filepath=file_path)
    return matches

if __name__ == "__main__":
    file_to_scan = input("Please upload the file you want to scan: ")
    yara_rules = "rules/yara/index.yar"
    hash_algorithm = "sha256"

    calculated_hash = calculate_file_hash(file_to_scan, hash_algorithm)
    save_hash_to_file(file_to_scan, calculated_hash)

    scan_results = scan_file(file_to_scan, yara_rules)
    if scan_results:
        print("[Malicious content detected]--->")
        table_data = [(match.rule,) for match in scan_results]
        print(tabulate(table_data, headers=["Matched YARA Rule"], tablefmt="grid"))
    else:
        print("No malicious content detected.")
